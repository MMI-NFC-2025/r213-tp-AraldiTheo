---
interface Props {
  id: string;
  nomMaison: string;
  adresse: string;
  prix: number;
  nbChambres: number;
  nbSdb: number;
  surface: number;
  imgUrl: ImageMetadata | string;
  favori?: boolean;
}

import type { ImageMetadata } from 'astro';

const { id, nomMaison, adresse, prix, nbChambres, nbSdb, surface, imgUrl, favori = false } = Astro.props;
const imageSrc = typeof imgUrl === 'string' ? imgUrl : imgUrl.src;
---

<div class="offre-card rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-all duration-300" id={`card-${id}`} data-offreid={id} data-favori={favori.toString()} style={`background: ${favori ? 'linear-gradient(120deg, #ff8c00 0%, #8b008b 100%)' : '#ffffff'}`}>
  <!-- Image Container -->
  <div class="relative w-full h-48 bg-gray-200 overflow-hidden">
    <img 
      src={imageSrc} 
      alt={nomMaison}
      class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
    />
    <button 
      class="toggle-favori absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full text-sm font-semibold transition-colors duration-200"
      type="button"
    >
      {favori ? '⭐ Favori' : '☆ Ajouter'}
    </button>
  </div>

  <!-- Content Container -->
  <div class="p-4">
    <!-- Title -->
    <h3 class="text-xl font-bold text-gray-800 mb-1 truncate">
      {nomMaison}
    </h3>

    <!-- Address -->
    <p class="text-gray-600 text-sm mb-3 truncate">
       {adresse}
    </p>

    <!-- Price -->
    <div class="text-2xl font-bold text-blue-600 mb-4">
      ${prix}
    </div>

    <!-- Details Grid -->
    <div class="grid grid-cols-3 gap-3 mb-4 border-t border-gray-200 pt-3">
      <div class="text-center">
        <p class="text-gray-500 text-xs uppercase font-semibold">Chambres</p>
        <p class="text-lg font-bold text-gray-800">{nbChambres}</p>
      </div>
      <div class="text-center">
        <p class="text-gray-500 text-xs uppercase font-semibold">Salle de bain</p>
        <p class="text-lg font-bold text-gray-800">{nbSdb}</p>
      </div>
      <div class="text-center">
        <p class="text-gray-500 text-xs uppercase font-semibold">Surface</p>
        <p class="text-lg font-bold text-gray-800">{surface} m²</p>
      </div>
    </div>

    <!-- Action Button -->
    <button class="w-full bg-blue-600 text-white py-2 rounded-md font-semibold hover:bg-blue-700 transition-colors duration-200" type="button">
      Voir les détails
    </button>
  </div>
</div>

<script define:vars={{ offreId: id }}>
  document.addEventListener('DOMContentLoaded', () => {
    const cardId = `card-${offreId}`;
    const card = document.getElementById(cardId);
    const toggleBtn = card?.querySelector('.toggle-favori');
    
    if (card && toggleBtn) {
      // Charger l'état du localStorage au chargement
      const savedFavori = localStorage.getItem(`favori-${offreId}`);
      
      if (savedFavori === 'true') {
        card.dataset.favori = 'true';
        card.style.background = 'linear-gradient(120deg, #ff8c00 0%, #8b008b 100%)';
        toggleBtn.textContent = '⭐ Favori';
      }
      
      // Ajouter l'événement click
      toggleBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        e.preventDefault();
        
        const isFavori = card.dataset.favori === 'true';
        const newFavoriState = !isFavori;
        
        // Sauvegarder dans localStorage
        localStorage.setItem(`favori-${offreId}`, newFavoriState.toString());
        
        // Mettre à jour l'affichage
        card.dataset.favori = newFavoriState.toString();
        card.style.background = newFavoriState ? 'linear-gradient(120deg, #ff8c00 0%, #8b008b 100%)' : '#ffffff';
        
        toggleBtn.textContent = newFavoriState ? '⭐ Favori' : '☆ Ajouter';
        
        console.log(`Favori ${offreId}:`, newFavoriState);
      });
    } else {
      console.warn(`Éléments non trouvés: card=${!!card}, btn=${!!toggleBtn}`);
    }
  });
</script>
